<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Галерея художника — чистый HTML/JS (без PHP)</title>
  <style>
    :root{
      --bg:#0b0e13; --fg:#e9eef6; --muted:#9aa3b2; --line:#1d2330; --glass:rgba(18,22,30,.45); --acc:#3b82f6;
      --shadow: 0 12px 35px rgba(0,0,0,.45);
    }
    :root.light{
      --bg:#f7f8fc; --fg:#0f1220; --muted:#55607a; --line:#dfe3ee; --glass:rgba(255,255,255,.55); --acc:#2563eb;
      --shadow: 0 10px 28px rgba(20,40,80,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .app{height:100%;display:grid;grid-template-rows:auto 1fr}

    header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;gap:8px;border-bottom:1px solid var(--line)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,#6ee7ff,#3b82f6,#9333ea)}
    .title{font-weight:700;letter-spacing:.2px}
    .leftStack{display:flex;align-items:center;gap:8px}
    .collections{position:relative}
    .collections button{border:1px solid var(--line);background:transparent;color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer}
    .menu{position:absolute;top:100%;left:0;min-width:220px;background:var(--bg);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none;z-index:5}
    .menu.open{display:block}
    .menu .item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;cursor:pointer}
    .menu .item:hover{background:rgba(128,128,128,.08)}
    .count{color:var(--muted);font-size:12px}
    .tools{display:flex;align-items:center;gap:8px}
    .btn{border:1px solid var(--line);background:transparent;color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer}

    .stage{position:relative;height:calc(100vh - 58px);overflow:hidden}
    .slide{position:absolute;inset:0;display:grid;place-items:center;opacity:0;transition:opacity .35s ease}
    .slide.active{opacity:1}
    .art{position:relative;width:100%;height:100%}
    .art img{position:absolute;inset:0;margin:auto;max-width:100%;max-height:100%;object-fit:contain;filter:drop-shadow(0 12px 24px rgba(0,0,0,.35))}
    .glass{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:10px;align-items:center;backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);background:var(--glass);border:1px solid var(--line);padding:10px 14px;border-radius:12px;color:var(--fg);box-shadow:var(--shadow)}
    .name{font-weight:700}
    .meta{color:var(--muted)}
    .nav{position:absolute;top:50%;transform:translateY(-50%);display:flex;align-items:center;justify-content:center;width:52px;height:52px;border-radius:50%;backdrop-filter: blur(8px);background:var(--glass);border:1px solid var(--line);box-shadow:var(--shadow);cursor:pointer;user-select:none}
    .nav:hover{transform:translateY(-50%) scale(1.06)}
    .prev{left:14px}
    .next{right:14px}
    .progress{position:absolute;left:50%;top:12px;transform:translateX(-50%);display:flex;gap:4px}
    .dot{width:24px;height:4px;border-radius:4px;background:rgba(255,255,255,.18)}
    .dot.on{background:var(--acc)}
    @keyframes ken1 { 0% { transform: scale(1) translate(0,0)} 100%{ transform: scale(1.08) translate(10px, -6px)} }
    @keyframes ken2 { 0% { transform: scale(1.02) translate(0,0)} 100%{ transform: scale(1.12) translate(-8px, 10px)} }
    .kenburns-1{ animation: ken1 18s ease-in-out forwards }
    .kenburns-2{ animation: ken2 18s ease-in-out forwards }
    .hint{position:absolute;bottom:72px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--muted)}
    @media (max-width:680px){
      .glass{left:12px;right:12px;transform:none}
      .nav{width:44px;height:44px}
      .progress{display:none}
    }

    .toolbar{display:flex;gap:8px;align-items:center}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="leftStack">
        <div class="brand"><div class="logo"></div><div class="title">Галерея</div></div>
        <div class="collections" id="collections">
          <button id="collectionsBtn">Коллекции</button>
          <div class="menu" id="collectionsMenu"></div>
        </div>
      </div>
      <div class="tools toolbar">
        <input id="dirPicker" type="file" webkitdirectory directory multiple class="hide" />
        <button class="btn" id="importBtn" title="Импортировать локальную папку paints">Импортировать папку</button>
        <button class="btn" id="saveManifestBtn" title="Скачать manifest.json" disabled>Скачать manifest.json</button>
        <button class="btn" id="themeBtn" title="Ночь/День">Ночь/День</button>
      </div>
    </header>

    <main class="stage" id="stage">
      <div class="nav prev" id="prev" aria-label="Предыдущая">◀</div>
      <div class="nav next" id="next" aria-label="Следующая">▶</div>
      <div class="progress" id="progress"></div>
      <div class="hint" id="hint">Свайпайте влево/вправо</div>
    </main>
  </div>

<script>
const root = document.documentElement;
const stage = document.getElementById('stage');
const btnPrev = document.getElementById('prev');
const btnNext = document.getElementById('next');
const progress = document.getElementById('progress');
const hint = document.getElementById('hint');
const collBtn = document.getElementById('collectionsBtn');
const collMenu = document.getElementById('collectionsMenu');
const themeBtn = document.getElementById('themeBtn');

const importBtn = document.getElementById('importBtn');
const dirPicker = document.getElementById('dirPicker');
const saveManifestBtn = document.getElementById('saveManifestBtn');

const state = {
  idx:0, filter:'all',
  list:[], all:[], collections:[],
  // для режима импорта из папки: карта filePath -> blobURL
  blobMap: new Map(),
  manifest: null, // последний собранный manifest для сохранения
};

(function initTheme(){
  const saved = localStorage.getItem('theme');
  if(saved==='light') root.classList.add('light');
  themeBtn.onclick = ()=>{
    root.classList.toggle('light');
    localStorage.setItem('theme', root.classList.contains('light')? 'light':'dark');
  }
})();

function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
function parseMeta(filename){
  const base = filename.replace(/\.[^.]+$/,'');
  let title=base, size='', materials='';
  if(base.includes('__')){ const [t,s,m]=base.split('__'); title=t||base; size=s||''; materials=m||''; }
  else if(base.includes(' - ')){ const [t,s,m]=base.split(' - '); title=t||base; size=s||''; materials=m||''; }
  return {title,size,materials};
}

// ===== 1) Пытаемся загрузить paints/manifest.json =====
async function boot(){
  try{
    const r = await fetch('paints/manifest.json', {cache:'no-store'});
    if(!r.ok) throw new Error('no manifest');
    const data = await r.json(); // {dir:'paints', groups:[{name,items:[{file}]}]}
    useManifest(data, /*fromImport=*/false);
  }catch(e){
    infoBox('Манифест не найден. Нажми «Импортировать папку» и выбери локальную папку paints (в ней подпапки: Astronauts, Cards, Flowers, Others, Text). После импорта можно «Скачать manifest.json».');
  }
}
boot();

// ===== 2) Импорт через <input type="file" webkitdirectory> =====
importBtn.onclick = ()=> dirPicker.click();

dirPicker.onchange = async (e)=>{
  const files = [...e.target.files];
  if(!files.length) return;

  // фильтруем изображения
  const allow = new Set(['jpg','jpeg','png','webp','gif','bmp','svg']);
  const imgs = files.filter(f=> allow.has(f.name.split('.').pop()?.toLowerCase()||'') );

  // группируем по первой подпапке после paints/
  // ожидаем относительный путь вида: paints/<Group>/<File>
  const groupsMap = new Map();
  state.blobMap.clear();

  for(const f of imgs){
    const rel = f.webkitRelativePath || f.name; // webkitRelativePath даёт путь от выбранной папки
    // ищем шаблон paints/<Group>/<File>
    const parts = rel.split(/[\\/]/);
    const paintsIdx = parts.findIndex(p=>p.toLowerCase()==='paints');
    if(paintsIdx===-1 || parts.length < paintsIdx+3) continue;
    const groupName = parts[paintsIdx+1];
    const fileName  = parts.slice(paintsIdx+2).join('/'); // поддержка вложений в группе
    const filePath  = groupName + '/' + fileName;

    const list = groupsMap.get(groupName) || [];
    list.push({ file: filePath, fileObj: f });
    groupsMap.set(groupName, list);
  }

  // строим manifest-подобный объект
  const manifest = { dir: 'paints', groups: [] };
  for(const [name, arr] of [...groupsMap.entries()].sort((a,b)=>a[0].localeCompare(b[0], 'ru'))){
    // сортируем файлы по имени
    arr.sort((a,b)=> a.file.localeCompare(b.file, 'ru', {numeric:true, sensitivity:'base'}));
    // создаём blobURL для каждого файла — чтобы <img> мог показать локальный файл
    const items = arr.map(({file, fileObj})=>{
      const url = URL.createObjectURL(fileObj);
      state.blobMap.set(file, url);
      return { file, url };
    });
    manifest.groups.push({ name, items });
  }

  state.manifest = manifest;
  useManifest(manifest, /*fromImport=*/true);
  saveManifestBtn.disabled = false;
};

// ===== Применить манифест к UI =====
function useManifest(data, fromImport){
  // коллекции
  state.collections = [{key:'all', name:'Все работы'}].concat(
    data.groups.map(g=>({key:g.name, name:g.name}))
  );
  // список работ
  state.all = data.groups.flatMap(g=>{
    return g.items.map(it=>{
      const fname = it.file.split('/').pop();
      const meta = parseMeta(fname);
      // если импорт из input — используем blob URL; иначе — относительный путь
      const src = fromImport
        ? (it.url || state.blobMap.get(it.file))  // импорт
        : `${data.dir}/${it.file}`;               // из статики
      return {
        series: g.name,
        name: meta.title,
        size: meta.size,
        materials: meta.materials,
        src
      };
    });
  });

  renderCollections();
  setFilter('all');
}

// ===== Меню коллекций =====
function renderCollections(){
  collMenu.innerHTML = '';
  state.collections.forEach(c=>{
    const count = c.key==='all' ? state.all.length : state.all.filter(w=>w.series===c.key).length;
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<span>${esc(c.name)}</span><span class="count">${count}</span>`;
    div.onclick = ()=>{ setFilter(c.key); collMenu.classList.remove('open'); };
    collMenu.appendChild(div);
  });
}
collBtn.onclick = ()=> collMenu.classList.toggle('open');
document.addEventListener('click', (e)=>{ if(!collMenu.contains(e.target) && e.target!==collBtn){ collMenu.classList.remove('open') } });

// ===== Рендер слайдов =====
function setFilter(key){
  state.filter = key;
  state.list = key==='all' ? state.all : state.all.filter(w=>w.series===key);
  if(!state.list.length){ clearSlides(); return; }
  buildSlides(); show(0); buildProgress();
}
function clearSlides(){ stage.querySelectorAll('.slide').forEach(n=>n.remove()); progress.innerHTML=''; }

function buildSlides(){
  stage.querySelectorAll('.slide').forEach(n=>n.remove());
  state.list.forEach(w=>{
    const slide = document.createElement('div'); slide.className='slide';
    const art = document.createElement('div'); art.className='art';
    const img = document.createElement('img'); img.alt = w.name; img.src = w.src;
    const glass = document.createElement('div'); glass.className='glass';
    glass.innerHTML = `<span class="name">${esc(w.name)}</span><span class="meta">${esc([w.size,w.materials].filter(Boolean).join(' • '))}</span>`;
    art.appendChild(img); art.appendChild(glass); slide.appendChild(art); stage.appendChild(slide);
  });
}
function buildProgress(){
  progress.innerHTML = '';
  state.list.forEach(()=>{ const d=document.createElement('div'); d.className='dot'; progress.appendChild(d); });
}
function show(i){
  state.idx = (i + state.list.length) % state.list.length;
  const slides = [...stage.querySelectorAll('.slide')];
  slides.forEach((s,idx)=> s.classList.toggle('active', idx===state.idx));
  [...progress.children].forEach((d,idx)=> d.classList.toggle('on', idx===state.idx));
  resetIdleMotion();
}
function next(){ show(state.idx+1) }
function prev(){ show(state.idx-1) }
btnNext.onclick = next; btnPrev.onclick = prev;
window.addEventListener('keydown', e=>{ if(e.key==='ArrowRight') next(); else if(e.key==='ArrowLeft') prev(); });

// свайпы
let touchX=null, touchY=null;
stage.addEventListener('touchstart', e=>{ const t=e.changedTouches[0]; touchX=t.clientX; touchY=t.clientY; stopIdleMotion(); },{passive:true});
stage.addEventListener('touchend', e=>{ const t=e.changedTouches[0]; const dx=t.clientX-touchX; const dy=Math.abs(t.clientY-touchY);
  if(Math.abs(dx)>40 && dy<80){ dx<0? next(): prev(); }
  startIdleTimer();
},{passive:true});
// колесо
stage.addEventListener('wheel', e=>{ if(Math.abs(e.deltaX)+Math.abs(e.deltaY)>0){ e.deltaY>0||e.deltaX>0? next(): prev(); stopIdleMotion(); startIdleTimer(); } },{passive:true});

// Ken Burns
let idleTimer=null, kenTimer=null, kenToggle=false;
function startIdleTimer(){ clearTimeout(idleTimer); idleTimer=setTimeout(()=> applyKenBurns(true), 2600); }
function resetIdleMotion(){ applyKenBurns(false); startIdleTimer(); hint.style.opacity=.0; }
function stopIdleMotion(){ applyKenBurns(false); clearTimeout(idleTimer); }
function applyKenBurns(on){
  const active = stage.querySelector('.slide.active img'); if(!active) return;
  active.classList.remove('kenburns-1','kenburns-2');
  if(on){ active.classList.add(kenToggle? 'kenburns-1':'kenburns-2'); kenToggle=!kenToggle; }
}

// ===== Сохранение manifest.json (если импортировали папку) =====
saveManifestBtn.onclick = ()=>{
  if(!state.collections.length || !state.all.length) return;
  // собрать манифест как в статике
  const groupsMap = new Map();
  for(const w of state.all){
    const arr = groupsMap.get(w.series) || [];
    // пытаемся восстановить имя файла (последний сегмент из title — недостоверно),
    // поэтому в режиме импорта сохраняли file в manifest.items.file.
    // Здесь не знаем исходный относительный путь, поэтому просим пользователя
    // хранить структуру paints/<Group>/<File> и имена файлов с метаданными.
    // В экспортируемом манифесте оставим только file (без blob url).
  }
  // Мы сохранили исходные пары в state.manifest при импорте — используем их.
  if(!state.manifest){ alert('Манифест недоступен. Импортируй папку заново.'); return; }
  const content = JSON.stringify(state.manifest, null, 2);
  const blob = new Blob([content], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'manifest.json';
  a.click();
  URL.revokeObjectURL(a.href);
};

// вспомогательный блок с подсказкой
function infoBox(html){
  const msg = document.createElement('div');
  msg.style.cssText='margin:90px auto;max-width:760px;padding:12px 14px;border:1px solid var(--line);background:var(--glass);backdrop-filter:blur(10px);border-radius:12px';
  msg.innerHTML = html;
  stage.appendChild(msg);
}

// меню коллекций
collBtn.onclick = ()=> collMenu.classList.toggle('open');
document.addEventListener('click', (e)=>{ if(!collMenu.contains(e.target) && e.target!==collBtn){ collMenu.classList.remove('open') } });
</script>
</body>
</html>
