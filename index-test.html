<script>
/* ======= Конфиг ======= */
const GH = { owner:'Hazpay', repo:'Galery-Ozerov-Ilya', branch:'main', dir:'paints' };
const API_BRANCH = `https://api.github.com/repos/${GH.owner}/${GH.repo}/branches/${encodeURIComponent(GH.branch)}`;
const RAW_BASE   = `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/`;
const MAX_RETRIES = 3;

/* ======= DOM ======= */
const $=s=>document.querySelector(s);
const topbar=$('#topbar'), colBox=$('#collections'), grid=$('#view-grid');
const viewer=$('#viewer'), big=$('#big'), vTitle=$('#v-title'), vMeta=$('#v-meta');
$('#next').onclick=next; $('#prev').onclick=prev; $('#close').onclick=closeViewer;
let catalog={}, flat=[], current=0;

/* ======= Утилиты ======= */
const isImg=f=>/\.(jpe?g|png|webp|gif|bmp|svg)$/i.test(f);
function parseName(f){ const b=f.replace(/\.[^.]+$/,''); let t=b,s='',m=''; if(b.includes('__'))[t,s,m]=b.split('__'); else if(b.includes(' - '))[t,s,m]=b.split(' - '); return{title:t||b,size:s||'',materials:m||''}; }
function groupBy(arr, fn){ return arr.reduce((a,x)=>{ const k=fn(x); (a[k]||(a[k]=[])).push(x); return a; },{}); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function cachedGet(key){ try{ return JSON.parse(localStorage.getItem(key)||'null'); }catch{return null;} }
function cachedSet(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }

async function fetchJSON(url, retries=MAX_RETRIES){
  for(let i=0;i<retries;i++){
    try{
      const r=await fetch(url, { headers:{ 'Accept':'application/vnd.github+json', 'Cache-Control':'no-cache' }});
      if(r.ok) return r.json();
      if(r.status===403 || r.status===429){ await sleep(700*(i+1)); continue; }
      throw new Error(`HTTP ${r.status}`);
    }catch(e){ if(i===retries-1) throw e; await sleep(500*(i+1)); }
  }
}

/* 1) Точный SHA ветки → 2) Рекурсивное дерево */
async function loadTree() {
  const cacheKey = `tree:${GH.owner}/${GH.repo}@${GH.branch}`;
  try{
    // шаг 1: узнаём SHA ветки
    const branch = await fetchJSON(API_BRANCH);
    const sha = branch?.commit?.sha;
    if(!sha) throw new Error('No branch SHA');

    // шаг 2: берём дерево репозитория по SHA (recursive=1)
    const apiTree = `https://api.github.com/repos/${GH.owner}/${GH.repo}/git/trees/${sha}?recursive=1`;
    const data = await fetchJSON(apiTree);

    if(!data?.tree) throw new Error('Bad tree');
    cachedSet(cacheKey, { ts: Date.now(), tree: data.tree });
    return data.tree;
  }catch(e){
    const c = cachedGet(cacheKey);
    if(c?.tree) return c.tree; // fallback на кэш
    throw e;
  }
}

async function buildCatalog(){
  const tree = await loadTree();
  const base = GH.dir.replace(/\/+$/,'')+'/';
  const items = tree
    .filter(n => n.type==='blob' && n.path.startsWith(base) && isImg(n.path))
    .map(n => {
      const rel = n.path.substring(base.length);
      const parts = rel.split('/');
      const collection = parts[0] || 'Misc';
      const file = parts.at(-1);
      const meta = parseName(file);
      return { collection, src: RAW_BASE + n.path, name: file, ...meta };
    });
  catalog = groupBy(items, x=>x.collection);
}

/* ======= UI ======= */
function buildUI(){
  colBox.innerHTML='';
  colBox.appendChild(pill('Все',()=>show('ALL'),true));
  Object.keys(catalog).sort((a,b)=>a.localeCompare(b,'ru',{numeric:true})).forEach(c=>{
    colBox.appendChild(pill(c,()=>show(c)));
  });
  show('ALL');
}
function pill(lbl, on, active){
  const el=document.createElement('div');
  el.className='pill'+(active?' active':'');
  el.textContent=lbl;
  el.onclick=()=>{
    document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
    el.classList.add('active'); on();
  };
  return el;
}
function show(scope){
  viewer.classList.remove('active');
  const items=[]; if(scope==='ALL'){ Object.values(catalog).forEach(a=>items.push(...a)); } else { items.push(...(catalog[scope]||[])); }
  flat=items;
  grid.innerHTML=items.map((it,i)=>`
    <article class="card" data-idx="${i}">
      <img loading="lazy" src="${it.src}" alt="${it.title}">
      <div class="caption">
        <div class="title">${it.title}</div>
        <div class="meta">${[it.collection,it.size,it.materials].filter(Boolean).join(' • ')}</div>
      </div>
    </article>`).join('');
  grid.querySelectorAll('.card').forEach(c=>c.onclick=()=>openViewer(+c.dataset.idx));
}

/* ======= Viewer ======= */
function openViewer(i){ current=(i+flat.length)%flat.length; render(); viewer.classList.add('active'); idleStart(); }
function closeViewer(){ viewer.classList.remove('active'); big.src=''; idleStop(); }
function render(){ const it=flat[current]; big.style.transform='none'; big.src=it.src; vTitle.textContent=it.title; vMeta.textContent=[it.collection,it.size,it.materials].filter(Boolean).join(' • '); }
function next(){ current=(current+1)%flat.length; render(); idleReset(); }
function prev(){ current=(current-1+flat.length)%flat.length; render(); idleReset(); }
window.addEventListener('keydown',e=>{ if(!viewer.classList.contains('active'))return; if(e.key==='ArrowRight')next(); else if(e.key==='ArrowLeft')prev(); else if(e.key==='Escape')closeViewer(); });
(function swipe(el){ let x0=null,y0=null; el.addEventListener('touchstart',e=>{const t=e.touches[0];x0=t.clientX;y0=t.clientY;idleStop();},{passive:true});
  el.addEventListener('touchend',e=>{ if(x0===null)return; const dx=e.changedTouches[0].clientX-x0,dy=Math.abs(e.changedTouches[0].clientY-y0);
    if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)) dx<0?next():prev(); idleStart(); x0=y0=null; },{passive:true}); })(viewer);

/* ======= Idle Ken Burns ======= */
let idleTimer=null, kenTimer=null;
function idleStart(){ clearTimeout(idleTimer); idleTimer=setTimeout(startKen, 4000);
  window.addEventListener('mousemove', idleResetOnce, {once:true});
  window.addEventListener('keydown', idleResetOnce, {once:true});
  viewer.addEventListener('touchstart', idleResetOnce, {once:true});
}
function idleReset(){ clearTimeout(idleTimer); clearTimeout(kenTimer); big.style.transform='none'; idleStart(); }
function idleResetOnce(){ idleReset(); }
function idleStop(){ clearTimeout(idleTimer); clearTimeout(kenTimer); big.style.transform='none'; }
function startKen(){ const s=1.1+Math.random()*0.05, tx=Math.random()*20-10, ty=Math.random()*20-10;
  big.style.transform=`scale(${s}) translate(${tx}vw,${ty}vh)`; kenTimer=setTimeout(()=>{ big.style.transform='none'; startKen(); }, 20000); }

/* ======= Сворачивание меню ======= */
let collapsed=false; topbar.onclick=()=>{ collapsed=!collapsed; colBox.classList.toggle('collapsed',collapsed); };

/* ======= Boot ======= */
(async()=>{
  try{
    await buildCatalog();
    buildUI();
  }catch(e){
    console.error(e);
    grid.innerHTML = `<div style="
      margin:90px auto;max-width:760px;padding:16px 18px;
      border:1px solid var(--line);background:var(--glass);
      backdrop-filter:blur(var(--blur));border-radius:18px;box-shadow:var(--shadow);">
      Ошибка загрузки. Проверь, что репозиторий публичный и в папке <b>${GH.dir}</b> есть изображения.
    </div>`;
  }
})();
</script>